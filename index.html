<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>倉儲巡檢系統</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: rgba(30, 58, 138, 0.25);
      --accent: #60a5fa;
      --accent2: #34d399;
      --text: #f1f5f9;
      --muted: #cbd5e1;
      --danger: #f87171;
      --gradient-blue: linear-gradient(135deg, #1e40af 0%, #3b82f6 25%, #60a5fa 75%, #93c5fd 100%);
      --gradient-green: linear-gradient(135deg, #059669 0%, #10b981 25%, #34d399 75%, #6ee7b7 100%);
      --gradient-mixed: linear-gradient(135deg, #1e40af 0%, #3b82f6 20%, #60a5fa 40%, #34d399 60%, #10b981 80%, #059669 100%);
      --gradient-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 15%, #334155 35%, #475569 50%, #334155 65%, #1e293b 85%, #0f172a 100%);
      --gradient-asymmetric: linear-gradient(127deg, #1e40af 0%, #3b82f6 18%, #60a5fa 32%, #34d399 58%, #10b981 78%, #059669 100%);
      --gradient-card: linear-gradient(143deg, rgba(30, 64, 175, 0.3) 0%, rgba(59, 130, 246, 0.25) 25%, rgba(96, 165, 250, 0.2) 45%, rgba(52, 211, 153, 0.25) 70%, rgba(16, 185, 129, 0.3) 100%);
      --gradient-button: linear-gradient(128deg, #1e40af 0%, #3b82f6 22%, #60a5fa 44%, #34d399 66%, #10b981 88%, #059669 100%);
      --shadow-blue: 0 8px 32px rgba(59, 130, 246, 0.3);
      --shadow-green: 0 8px 32px rgba(16, 185, 129, 0.3);
      --shadow-mixed: 0 12px 40px rgba(59, 130, 246, 0.25), 0 8px 24px rgba(16, 185, 129, 0.2);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--gradient-bg);
      background-attachment: fixed;
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 80px;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(ellipse at 15% 25%, rgba(30, 64, 175, 0.35) 0%, transparent 65%),
        radial-gradient(ellipse at 85% 75%, rgba(16, 185, 129, 0.35) 0%, transparent 65%),
        radial-gradient(ellipse at 50% 10%, rgba(96, 165, 250, 0.2) 0%, transparent 70%),
        radial-gradient(ellipse at 20% 80%, rgba(52, 211, 153, 0.25) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 20%, rgba(59, 130, 246, 0.2) 0%, transparent 55%);
      pointer-events: none;
      z-index: 0;
      animation: backgroundShift 20s ease-in-out infinite alternate;
    }
    @keyframes backgroundShift {
      0% { transform: translateX(0) translateY(0) scale(1); }
      100% { transform: translateX(-2%) translateY(2%) scale(1.02); }
    }
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        linear-gradient(45deg, transparent 30%, rgba(96, 165, 250, 0.08) 50%, transparent 70%),
        linear-gradient(-45deg, transparent 30%, rgba(52, 211, 153, 0.08) 50%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }
    .navbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--gradient-card);
      backdrop-filter: blur(25px) saturate(200%);
      border-bottom: 2px solid transparent;
      border-image: var(--gradient-mixed) 1;
      box-shadow: 
        var(--shadow-mixed),
        inset 0 2px 0 rgba(255, 255, 255, 0.15),
        inset 0 -1px 0 rgba(255, 255, 255, 0.05);
      display: flex;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }
    .navbar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient-asymmetric);
      opacity: 0.1;
      pointer-events: none;
    }
    .navbar button {
      flex: 0 0 auto;
      padding: 14px 20px;
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 15px;
      font-weight: 500;
      white-space: nowrap;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: 1;
    }
    .navbar button::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 90%;
      height: 3px;
      background: var(--gradient-button);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 2px 2px 0 0;
      box-shadow: 0 -2px 8px rgba(96, 165, 250, 0.4);
    }
    .navbar button::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient-button);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 0;
    }
    .navbar button:hover {
      color: #93c5fd;
      transform: translateY(-1px);
    }
    .navbar button:hover::after {
      opacity: 0.1;
    }
    .navbar button.active {
      color: #60a5fa;
      background: rgba(59, 130, 246, 0.15);
      text-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
    }
    .navbar button.active::before {
      transform: translateX(-50%) scaleX(1);
    }
    .container { 
      padding: 20px; 
      max-width: 600px; 
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .card {
      background: var(--gradient-card);
      backdrop-filter: blur(30px) saturate(200%);
      border-radius: 24px;
      padding: 28px;
      margin-bottom: 24px;
      border: 2px solid transparent;
      border-image: var(--gradient-mixed) 1;
      box-shadow: 
        var(--shadow-mixed),
        0 4px 20px rgba(0, 0, 0, 0.15),
        inset 0 2px 0 rgba(255, 255, 255, 0.25),
        inset 0 -2px 0 rgba(255, 255, 255, 0.08);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--gradient-button);
      opacity: 0.9;
      box-shadow: 0 2px 12px rgba(96, 165, 250, 0.5);
    }
    .card::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
    }
    .card:hover {
      transform: translateY(-6px) scale(1.01);
      background: linear-gradient(143deg, rgba(30, 64, 175, 0.35) 0%, rgba(59, 130, 246, 0.3) 25%, rgba(96, 165, 250, 0.25) 45%, rgba(52, 211, 153, 0.3) 70%, rgba(16, 185, 129, 0.35) 100%);
      border-image: linear-gradient(128deg, #3b82f6 0%, #60a5fa 33%, #34d399 66%, #10b981 100%) 1;
      box-shadow: 
        0 20px 60px rgba(59, 130, 246, 0.4),
        0 12px 32px rgba(16, 185, 129, 0.3),
        0 8px 24px rgba(0, 0, 0, 0.2),
        inset 0 3px 0 rgba(255, 255, 255, 0.3),
        inset 0 -3px 0 rgba(255, 255, 255, 0.1);
    }
    .card:hover::after {
      opacity: 1;
    }
    .card h3 { 
      font-size: 15px; 
      color: var(--muted); 
      margin-bottom: 12px;
      font-weight: 600;
      background: var(--gradient-blue);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    label { 
      display: block; 
      font-size: 14px; 
      color: var(--muted); 
      margin-bottom: 6px; 
      font-weight: 500;
    }
    input[type="text"], select {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid transparent;
      border-image: linear-gradient(135deg, rgba(96, 165, 250, 0.4) 0%, rgba(52, 211, 153, 0.4) 100%) 1;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(30, 64, 175, 0.25) 0%, rgba(16, 185, 129, 0.2) 100%);
      backdrop-filter: blur(25px) saturate(180%);
      color: var(--text);
      font-size: 16px;
      margin-bottom: 18px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        inset 0 3px 8px rgba(0, 0, 0, 0.15),
        0 4px 12px rgba(96, 165, 250, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
      position: relative;
    }
    input[type="text"]:focus, select:focus {
      outline: none;
      border-image: var(--gradient-button) 1;
      background: linear-gradient(135deg, rgba(30, 64, 175, 0.35) 0%, rgba(16, 185, 129, 0.3) 100%);
      box-shadow: 
        inset 0 3px 8px rgba(0, 0, 0, 0.15),
        0 0 0 4px rgba(96, 165, 250, 0.4),
        0 8px 24px rgba(96, 165, 250, 0.5),
        0 4px 16px rgba(16, 185, 129, 0.3),
        inset 0 2px 0 rgba(255, 255, 255, 0.25);
      transform: translateY(-2px) scale(1.01);
    }
    select { cursor: pointer; }

    .photo-row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
    .photo-box {
      flex: 1;
      min-width: 130px;
      aspect-ratio: 4/3;
      border: 3px dashed transparent;
      border-image: linear-gradient(135deg, rgba(96, 165, 250, 0.6) 0%, rgba(52, 211, 153, 0.6) 100%) 1;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gradient-card);
      backdrop-filter: blur(20px);
      cursor: pointer;
      overflow: hidden;
      position: relative;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        0 8px 24px rgba(96, 165, 250, 0.25),
        0 4px 12px rgba(16, 185, 129, 0.2),
        inset 0 2px 0 rgba(255, 255, 255, 0.15);
    }
    .photo-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient-button);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 17px;
    }
    .photo-box:hover {
      border-image: var(--gradient-button) 1;
      background: linear-gradient(135deg, rgba(30, 64, 175, 0.35) 0%, rgba(16, 185, 129, 0.3) 100%);
      transform: translateY(-4px) scale(1.03);
      box-shadow: 
        0 16px 40px rgba(96, 165, 250, 0.4),
        0 8px 24px rgba(16, 185, 129, 0.3),
        inset 0 3px 0 rgba(255, 255, 255, 0.25);
    }
    .photo-box:hover::before {
      opacity: 0.1;
    }
    .photo-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 17px; }
    .photo-box .placeholder { 
      color: var(--muted); 
      font-size: 13px; 
      text-align: center; 
      padding: 12px;
      font-weight: 500;
      z-index: 1;
      position: relative;
    }
    .photo-box input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; }

    .btn {
      display: inline-block;
      padding: 18px 32px;
      background: var(--gradient-button);
      color: #fff;
      border: none;
      border-radius: 18px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      box-shadow: 
        var(--shadow-mixed),
        0 6px 16px rgba(59, 130, 246, 0.4),
        inset 0 2px 0 rgba(255, 255, 255, 0.5),
        inset 0 -2px 0 rgba(0, 0, 0, 0.15);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      letter-spacing: 0.5px;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s ease;
    }
    .btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(128deg, #3b82f6 0%, #60a5fa 33%, #34d399 66%, #10b981 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 18px;
    }
    .btn:hover::before {
      left: 100%;
    }
    .btn:hover::after {
      opacity: 1;
    }
    .btn:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 
        0 20px 50px rgba(96, 165, 250, 0.6),
        0 12px 30px rgba(16, 185, 129, 0.4),
        0 8px 20px rgba(59, 130, 246, 0.5),
        inset 0 3px 0 rgba(255, 255, 255, 0.6),
        inset 0 -3px 0 rgba(0, 0, 0, 0.15);
      filter: brightness(1.15);
    }
    .btn:active {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 
        0 8px 20px rgba(96, 165, 250, 0.4),
        inset 0 3px 6px rgba(0, 0, 0, 0.25);
    }
    .btn:disabled { 
      opacity: .5; 
      cursor: not-allowed; 
      transform: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .btn.secondary { 
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(51, 65, 85, 0.8) 100%);
      border: 2px solid transparent;
      border-image: linear-gradient(135deg, rgba(59, 130, 246, 0.4) 0%, rgba(52, 211, 153, 0.4) 100%) 1;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    .btn.secondary:hover {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.9) 100%);
      border-image: var(--gradient-button) 1;
    }

    .score-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 13px;
      font-weight: 700;
      margin-right: 10px;
      margin-bottom: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .score-badge::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .score-badge.safety { 
      background: linear-gradient(135deg, rgba(30,64,175,.4) 0%, rgba(59,130,246,.35) 50%, rgba(96,165,250,.3) 100%);
      color: #93c5fd;
      border: 2px solid rgba(59, 130, 246, 0.4);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    .score-badge.safety:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
      border-color: rgba(59, 130, 246, 0.6);
    }
    .score-badge.safety:hover::before {
      opacity: 1;
    }
    .score-badge.clean { 
      background: linear-gradient(135deg, rgba(5,150,105,.4) 0%, rgba(16,185,129,.35) 50%, rgba(52,211,153,.3) 100%);
      color: #6ee7b7;
      border: 2px solid rgba(16, 185, 129, 0.4);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    .score-badge.clean:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
      border-color: rgba(16, 185, 129, 0.6);
    }
    .score-badge.clean:hover::before {
      opacity: 1;
    }

    .record-item {
      border-left: 5px solid transparent;
      border-image: var(--gradient-button) 1;
      padding-left: 20px;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.08) 0%, rgba(16, 185, 129, 0.05) 50%, transparent 100%);
      border-radius: 0 12px 12px 0;
      padding-top: 12px;
      padding-bottom: 12px;
      position: relative;
      overflow: hidden;
    }
    .record-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient-button);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 0 12px 12px 0;
    }
    .record-item:hover { 
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.2) 0%, rgba(16, 185, 129, 0.15) 50%, transparent 100%);
      transform: translateX(6px) scale(1.01);
      box-shadow: -6px 0 20px rgba(59, 130, 246, 0.3);
      border-image: linear-gradient(135deg, #3b82f6 0%, #34d399 100%) 1;
    }
    .record-item:hover::before {
      opacity: 0.05;
    }
    .record-item .meta { 
      font-size: 12px; 
      color: var(--muted); 
      margin-bottom: 6px;
      font-weight: 500;
    }
    .record-item .feedback { 
      font-size: 14px; 
      line-height: 1.6; 
      margin-top: 10px;
    }

    .area-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .area-card {
      background: var(--gradient-card);
      backdrop-filter: blur(25px) saturate(200%);
      border-radius: 22px;
      padding: 24px;
      border: 2px solid transparent;
      border-image: linear-gradient(135deg, rgba(96, 165, 250, 0.4) 0%, rgba(52, 211, 153, 0.4) 100%) 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 
        var(--shadow-mixed),
        0 6px 16px rgba(0, 0, 0, 0.2),
        inset 0 2px 0 rgba(255, 255, 255, 0.25),
        inset 0 -2px 0 rgba(255, 255, 255, 0.08);
      position: relative;
      overflow: hidden;
    }
    .area-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--gradient-button);
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .area-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient-button);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 20px;
    }
    .area-card:hover { 
      transform: translateY(-6px) scale(1.03);
      border-image: var(--gradient-button) 1;
      box-shadow: 
        0 16px 40px rgba(59, 130, 246, 0.4),
        0 12px 30px rgba(16, 185, 129, 0.3),
        inset 0 3px 0 rgba(255, 255, 255, 0.2);
    }
    .area-card:hover::before {
      opacity: 1;
    }
    .area-card:hover::after {
      opacity: 0.05;
    }
    .area-card:active { transform: translateY(-3px) scale(1.02); }
    .area-card-content { width: 100%; z-index: 1; position: relative; }
    .area-card-thumb {
      width: 85px;
      height: 85px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid transparent;
      background: var(--gradient-card);
      display: block;
      box-shadow: 
        0 8px 25px rgba(96, 165, 250, 0.4),
        inset 0 0 0 4px rgba(96, 165, 250, 0.5),
        0 0 25px rgba(96, 165, 250, 0.3);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1;
      position: relative;
    }
    .area-card:hover .area-card-thumb {
      box-shadow: 
        0 15px 40px rgba(96, 165, 250, 0.6),
        inset 0 0 0 4px rgba(96, 165, 250, 0.7),
        0 0 35px rgba(96, 165, 250, 0.5);
      transform: scale(1.1) rotate(5deg);
      border: 4px solid rgba(96, 165, 250, 0.7);
    }
    .area-card-thumb-placeholder {
      width: 85px;
      height: 85px;
      border-radius: 50%;
      background: var(--gradient-button);
      backdrop-filter: blur(15px);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 28px;
      font-weight: 900;
      border: 4px solid rgba(96, 165, 250, 0.5);
      box-shadow: 
        0 8px 25px rgba(96, 165, 250, 0.4),
        inset 0 2px 0 rgba(255, 255, 255, 0.3);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      z-index: 1;
      position: relative;
    }
    .area-card .area-name { 
      font-size: 22px; 
      font-weight: 800; 
      background: var(--gradient-button);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      text-shadow: 0 0 25px rgba(96, 165, 250, 0.4);
      z-index: 1;
      position: relative;
    }
    .area-card .no-data { 
      font-size: 12px; 
      color: var(--muted); 
      font-weight: 500;
      z-index: 1;
      position: relative;
    }

    .calendar-wrap { margin-bottom: 20px; }
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .cal-header button { 
      background: var(--gradient-card);
      backdrop-filter: blur(15px);
      border: 2px solid transparent;
      border-image: linear-gradient(135deg, rgba(59, 130, 246, 0.4) 0%, rgba(52, 211, 153, 0.4) 100%) 1;
      color: var(--text); 
      padding: 10px 18px; 
      border-radius: 12px; 
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      font-weight: 600;
    }
    .cal-header button:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(16, 185, 129, 0.25) 100%);
      border-image: var(--gradient-button) 1;
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; font-size: 13px; }
    .cal-cell { 
      padding: 10px; 
      border-radius: 10px; 
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
    }
    .cal-cell.other { color: var(--muted); opacity: .6; }
    .cal-cell.has-data { 
      background: linear-gradient(135deg, rgba(59,130,246,.4) 0%, rgba(96,165,250,.3) 50%, rgba(52,211,153,.3) 100%);
      color: #93c5fd;
      border: 2px solid rgba(59, 130, 246, 0.5);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      font-weight: 700;
    }
    .cal-cell.has-data:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
    }
    .cal-cell.selected { 
      background: var(--gradient-button);
      color: #fff;
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.6);
      transform: scale(1.08);
      font-weight: 800;
    }
    .cal-cell.today { 
      border: 3px solid var(--accent2);
      box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
      background: rgba(16, 185, 129, 0.1);
    }

    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      padding: 16px 28px;
      border-radius: 16px;
      font-size: 14px;
      font-weight: 600;
      z-index: 999;
      max-width: 90%;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(15px);
      letter-spacing: 0.3px;
    }
    .toast.success { 
      background: var(--gradient-green);
      color: #fff;
      box-shadow: 0 12px 32px rgba(16, 185, 129, 0.5);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    .toast.error { 
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 50%, #f87171 100%);
      color: #fff;
      box-shadow: 0 12px 32px rgba(239, 68, 68, 0.5);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .loading { opacity: .7; pointer-events: none; }
    .empty { 
      text-align: center; 
      color: var(--muted); 
      padding: 28px; 
      font-size: 14px;
      font-weight: 500;
    }

    /* 浮動視窗（Modal）樣式 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(12px) saturate(150%);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: var(--gradient-card);
      backdrop-filter: blur(35px) saturate(220%);
      border-radius: 28px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      border: 2px solid transparent;
      border-image: var(--gradient-button) 1;
      box-shadow: 
        0 32px 100px rgba(96, 165, 250, 0.4),
        0 20px 60px rgba(52, 211, 153, 0.3),
        inset 0 3px 0 rgba(255, 255, 255, 0.35),
        inset 0 -3px 0 rgba(255, 255, 255, 0.15);
    }
    .modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: var(--gradient-button);
      opacity: 0.95;
      box-shadow: 0 3px 15px rgba(96, 165, 250, 0.6);
      border-radius: 28px 28px 0 0;
    }
    .modal-header {
      padding: 28px 32px;
      border-bottom: 2px solid transparent;
      border-image: linear-gradient(90deg, rgba(96, 165, 250, 0.4) 0%, rgba(52, 211, 153, 0.4) 100%) 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, rgba(30, 64, 175, 0.45) 0%, rgba(30, 64, 175, 0.4) 100%);
      backdrop-filter: blur(25px) saturate(200%);
      z-index: 10;
      border-radius: 28px 28px 0 0;
    }
    .modal-header h3 {
      font-size: 22px;
      font-weight: 800;
      background: var(--gradient-button);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
    }
    .modal-close {
      background: rgba(59, 130, 246, 0.15);
      border: 2px solid rgba(59, 130, 246, 0.4);
      color: var(--muted);
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      font-weight: bold;
    }
    .modal-close:hover { 
      background: rgba(59, 130, 246, 0.25);
      border-color: rgba(59, 130, 246, 0.6);
      color: #93c5fd;
      transform: rotate(90deg) scale(1.1);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }
    .modal-body {
      padding: 24px;
    }
    .modal-images {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .modal-image {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,.15);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }
    .modal-image img {
      width: 100%;
      height: auto;
      display: block;
    }
    .modal-scores {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
    }
    .modal-info {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 20px;
      font-weight: 500;
      line-height: 1.6;
    }
    .modal-feedback {
      font-size: 15px;
      line-height: 1.8;
      color: var(--text);
    }
    /* Markdown 樣式 - 更明顯的格式差異 */
    .markdown-content {
      font-size: 15px;
      line-height: 2;
      color: var(--text);
    }
    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4 {
      color: #60a5fa;
      margin-top: 1.8em;
      margin-bottom: 1em;
      font-weight: 800;
    }
    .markdown-content h1 { 
      font-size: 1.9em; 
      border-bottom: 4px solid transparent;
      border-image: var(--gradient-button) 1;
      padding-bottom: 0.6em;
      color: #93c5fd;
    }
    .markdown-content h2 { 
      font-size: 1.6em; 
      color: #60a5fa;
      border-bottom: 3px solid rgba(59,130,246,0.4);
      padding-bottom: 0.4em;
    }
    .markdown-content h3 { 
      font-size: 1.4em; 
      color: #7dd3fc;
    }
    .markdown-content h4 { 
      font-size: 1.2em; 
      color: #93c5fd;
    }
    .markdown-content p {
      margin: 1.8em 0;
      padding: 1em 0;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .markdown-content p:last-child {
      border-bottom: none;
    }
    .markdown-content p:first-child {
      margin-top: 0.6em;
    }
    .markdown-content ul,
    .markdown-content ol {
      margin: 1.4em 0;
      padding-left: 2.2em;
    }
    .markdown-content li {
      margin: 1em 0;
      line-height: 1.9;
    }
    .markdown-content strong {
      font-weight: 800;
      color: #60a5fa;
      font-size: 1.06em;
    }
    .markdown-content em {
      font-style: italic;
      color: #93c5fd;
    }
    .markdown-content code {
      background: rgba(0,0,0,.4);
      padding: 3px 8px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      color: var(--accent2);
      border: 1px solid rgba(52, 211, 153, 0.3);
    }
    .markdown-content pre {
      background: rgba(0,0,0,.4);
      padding: 16px;
      border-radius: 10px;
      overflow-x: auto;
      margin: 1.2em 0;
      border-left: 4px solid var(--accent);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .markdown-content pre code {
      background: none;
      padding: 0;
      color: var(--text);
      border: none;
    }
    .markdown-content blockquote {
      border-left: 4px solid var(--accent);
      padding-left: 1.2em;
      margin: 1.2em 0;
      color: var(--muted);
      font-style: italic;
      background: rgba(96, 165, 250, 0.05);
      padding: 1em 1.2em;
      border-radius: 0 8px 8px 0;
    }
    .markdown-content hr {
      border: none;
      border-top: 2px solid rgba(255,255,255,.15);
      margin: 2em 0;
    }
    .markdown-content a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }
    .markdown-content a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <button type="button" data-tab="upload" class="active">上傳巡檢</button>
    <button type="button" data-tab="areas">六區看板</button>
    <button type="button" data-tab="list">時間列表</button>
    <button type="button" data-tab="calendar">日曆</button>
  </nav>

  <main class="container">
    <section id="tab-upload" class="tab-panel">
      <div class="card">
        <h3>本次巡檢</h3>
        <label>廠區</label>
        <select id="area">
          <option value="">請選擇</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
          <option value="E">E</option>
          <option value="F">F</option>
        </select>
        <label>主管姓名</label>
        <input type="text" id="supervisor" placeholder="請輸入姓名" autocomplete="name">
        <label>照片 1（必填）</label>
        <div class="photo-row">
          <div class="photo-box" data-idx="1">
            <span class="placeholder">點擊拍照／選檔</span>
            <img style="display:none" alt="">
            <input type="file" accept="image/*" capture="environment" aria-label="照片1">
          </div>
          <div class="photo-box" data-idx="2">
            <span class="placeholder">點擊拍照／選檔</span>
            <img style="display:none" alt="">
            <input type="file" accept="image/*" capture="environment" aria-label="照片2">
          </div>
        </div>
        <button type="button" class="btn" id="btnUpload">上傳並取得 AI 分析</button>
      </div>
      <div id="uploadResult" class="card" style="display:none">
        <h3>分析結果</h3>
        <div id="uploadFeedback"></div>
      </div>
    </section>

    <section id="tab-areas" class="tab-panel" style="display:none">
      <div class="card">
        <h3>各廠區最新回饋（依時間序）</h3>
        <div id="areasBoard" class="area-grid"></div>
      </div>
    </section>

    <section id="tab-list" class="tab-panel" style="display:none">
      <div class="card">
        <h3>全部巡檢紀錄（新→舊）</h3>
        <div id="listRecords"></div>
      </div>
    </section>

    <section id="tab-calendar" class="tab-panel" style="display:none">
      <div class="card calendar-wrap">
        <div class="cal-header">
          <button type="button" id="calPrev">上月</button>
          <span id="calTitle">2025-01</span>
          <button type="button" id="calNext">下月</button>
        </div>
        <div id="calGrid" class="cal-grid"></div>
      </div>
      <div class="card">
        <h3 id="calDateTitle">點選日期查看該日巡視紀錄</h3>
        <div id="calDayRecords"></div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" style="display:none" role="alert"></div>

  <!-- 浮動視窗（Modal） -->
  <div id="recordModal" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">巡視紀錄詳情</h3>
        <button type="button" class="modal-close" aria-label="關閉">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    (function() {
      // 請改為您的 GAS 網頁應用程式網址（部署後於 GAS 部署畫面取得完整 URL）
      var GAS_APP_URL = 'https://script.google.com/macros/s/AKfycbxbNrzYR-yneU8mjpq08900zvSElaXH-qciQ_ZjvSsv3Rje42NVIbrw12RgvlxPMJQsWg/exec';

      function fetchJson(url, opt) {
        opt = opt || {};
        return fetch(url, {
          method: opt.method || 'GET',
          headers: opt.headers || {},
          body: opt.body
        }).then(function(r) { return r.json(); });
      }

      function callUpload(data) {
        // 移除 Content-Type header 以避免觸發 CORS 預檢請求
        // Google Apps Script 仍可正確解析 JSON body
        return fetchJson(GAS_APP_URL, {
          method: 'POST',
          headers: {},
          body: JSON.stringify(data)
        });
      }
      function callGetRecords(date, limit) {
        var q = 'action=getRecords&limit=' + (limit || 100);
        if (date) q += '&date=' + encodeURIComponent(date);
        return fetchJson(GAS_APP_URL + '?' + q);
      }
      function callGetDates(yyyy, mm) {
        return fetchJson(GAS_APP_URL + '?action=getDates&yyyy=' + encodeURIComponent(yyyy || '') + '&mm=' + encodeURIComponent(mm || ''));
      }
      function callGetAreas() {
        return fetchJson(GAS_APP_URL + '?action=getAreas');
      }

      document.querySelectorAll('.navbar button').forEach(function(b) {
        b.addEventListener('click', function() {
          document.querySelectorAll('.navbar button').forEach(function(x) { x.classList.remove('active'); });
          document.querySelectorAll('.tab-panel').forEach(function(p) { p.style.display = 'none'; });
          b.classList.add('active');
          var id = 'tab-' + b.getAttribute('data-tab');
          var panel = document.getElementById(id);
          if (panel) panel.style.display = 'block';
          if (id === 'tab-areas') loadAreas();
          if (id === 'tab-list') loadList();
          if (id === 'tab-calendar') renderCal();
        });
      });

      var photos = { 1: null, 2: null };
      document.querySelectorAll('.photo-box input').forEach(function(inp) {
        inp.addEventListener('change', function() {
          var f = this.files[0];
          if (!f) return;
          var idx = this.closest('.photo-box').getAttribute('data-idx');
          var box = this.closest('.photo-box');
          var img = box.querySelector('img');
          var pl = box.querySelector('.placeholder');
          var r = new FileReader();
          r.onload = function() {
            photos[idx] = r.result;
            img.src = r.result;
            img.style.display = 'block';
            if (pl) pl.style.display = 'none';
          };
          r.readAsDataURL(f);
        });
      });

      // 清空表單函數
      function resetUploadForm() {
        // 清空區域選擇
        document.getElementById('area').value = '';
        // 保留主管姓名（通常同一 session 是同一個主管）
        // 如需完全清空，可取消下面這行的註解
        // document.getElementById('supervisor').value = '';
        
        // 清空照片
        photos[1] = photos[2] = null;
        document.querySelectorAll('.photo-box img').forEach(function(i) {
          i.src = '';
          i.style.display = 'none';
        });
        document.querySelectorAll('.photo-box .placeholder').forEach(function(p) {
          p.style.display = 'block';
        });
        document.querySelectorAll('.photo-box input').forEach(function(i) {
          i.value = '';
        });
      }

      document.getElementById('btnUpload').addEventListener('click', function() {
        var area = document.getElementById('area').value;
        var supervisor = document.getElementById('supervisor').value.trim();
        if (!area || !supervisor) { showToast('請選擇廠區並填寫主管姓名', 'error'); return; }
        if (!photos[1] || !photos[2]) { showToast('請上傳 2 張照片', 'error'); return; }
        if (!GAS_APP_URL || GAS_APP_URL.indexOf('XXXXXXXX') >= 0) { showToast('請先在 index.html 中設定 GAS_APP_URL', 'error'); return; }

        var btn = this;
        var savedArea = area; // 保存用於顯示結果
        var savedSupervisor = supervisor; // 保存用於顯示結果
        
        // 先保存照片資料（因為要立即清空表單）
        var photo1Base64 = photos[1];
        var photo2Base64 = photos[2];
        
        btn.disabled = true;
        btn.textContent = '上傳中…';
        document.getElementById('uploadResult').style.display = 'none';

        // 立即清空表單，讓用戶可以開始下一個區域的作業
        resetUploadForm();
        btn.disabled = false;
        btn.textContent = '上傳並取得 AI 分析';
        showToast('已上傳，分析中…');

        // 發送上傳請求（異步處理）
        callUpload({ area: savedArea, supervisor: savedSupervisor, photo1Base64: photo1Base64, photo2Base64: photo2Base64 }).then(function(res) {
          if (res.success) {
            var html = '';
            html += '<div class="score-badge safety">環境安全度 ' + (res.safetyScore != null ? res.safetyScore : '–') + '</div>';
            html += '<div class="score-badge clean">環境清潔度 ' + (res.cleanlinessScore != null ? res.cleanlinessScore : '–') + '</div>';
            html += '<div class="record-item"><div class="feedback">' + (res.feedback || res.summary || '').replace(/\n/g, '<br>') + '</div></div>';
            document.getElementById('uploadFeedback').innerHTML = html;
            document.getElementById('uploadResult').style.display = 'block';
            showToast('分析完成：廠區 ' + savedArea);
          } else {
            showToast(res.error || '上傳失敗', 'error');
          }
        }).catch(function(e) {
          showToast(String(e && e.message || e || '網路錯誤，請確認 GAS_APP_URL 與 CORS'), 'error');
        });
      });

      function loadAreas() {
        var el = document.getElementById('areasBoard');
        el.innerHTML = '<div class="empty">載入中…</div>';
        if (!GAS_APP_URL || GAS_APP_URL.indexOf('XXXXXXXX') >= 0) { el.innerHTML = '<div class="empty">請先設定 GAS_APP_URL</div>'; return; }
        callGetRecords(null, 200).then(function(rows) {
          var byArea = {};
          'ABCDEF'.split('').forEach(function(a) { byArea[a] = []; });
          (rows || []).forEach(function(r) { if (byArea[r.area]) byArea[r.area].push(r); });
          var html = '';
          var areaRecords = {}; // 儲存每個廠區的最新紀錄，用於點擊事件
          'ABCDEF'.split('').forEach(function(a) {
            var arr = byArea[a] || [];
            var last = arr[0];
            if (last) areaRecords[a] = last; // 儲存最新紀錄
            html += '<div class="area-card" data-area="' + a + '">';
            // 處理縮圖
            if (last && last.photo1Url) {
              // 將 Google Drive 編輯 URL 轉換為圖片預覽 URL
              var imgUrl = last.photo1Url;
              var fileId = null;
              // 嘗試多種 Google Drive URL 格式提取文件 ID
              var match1 = imgUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
              if (match1 && match1[1]) {
                fileId = match1[1];
              } else {
                var match2 = imgUrl.match(/id=([a-zA-Z0-9_-]+)/);
                if (match2 && match2[1]) {
                  fileId = match2[1];
                } else {
                  // 嘗試提取長度 25-33 的字元串（Google Drive ID 的常見長度）
                  var match3 = imgUrl.match(/[a-zA-Z0-9_-]{25,33}/);
                  if (match3) {
                    fileId = match3[0];
                  }
                }
              }
              if (fileId) {
                // 使用 thumbnail API 獲取縮圖（更可靠）
                imgUrl = 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w200';
              }
              html += '<img class="area-card-thumb" src="' + imgUrl + '" alt="廠區 ' + a + '" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\'" />';
              html += '<div class="area-card-thumb-placeholder" style="display: none;">' + a + '</div>';
            } else {
              html += '<div class="area-card-thumb-placeholder">' + a + '</div>';
            }
            html += '<div class="area-card-content"><div class="area-name">廠區 '
+ a + '</div>';
            if (!last) html += '<div class="no-data">尚無回饋</div>';
            else {
              // 格式化時間：yyyy/mm/dd hh:mm
              var dateTimeStr = '';
              if (last.dateStr && last.timeStr) {
                var datePart = String(last.dateStr).substring(0, 10).replace(/-/g, '/');
                var timePart = String(last.timeStr).substring(0, 5); // 只取 HH:mm
                dateTimeStr = datePart + ' ' + timePart;
              } else if (last.timestamp) {
                // 如果只有 timestamp，格式化它
                var dt = new Date(last.timestamp);
                if (!isNaN(dt.getTime())) {
                  var y = dt.getFullYear();
                  var m = String(dt.getMonth() + 1).padStart(2, '0');
                  var d = String(dt.getDate()).padStart(2, '0');
                  var h = String(dt.getHours()).padStart(2, '0');
                  var min = String(dt.getMinutes()).padStart(2, '0');
                  dateTimeStr = y + '/' + m + '/' + d + ' ' + h + ':' + min;
                }
              }
              html += '<span class="score-badge safety">安全 ' + (last.safetyScore != null ? last.safetyScore : '–') + '</span>';
              html += '<span class="score-badge clean">清潔 ' + (last.cleanlinessScore != null ? last.cleanlinessScore : '–') + '</span>';
              html += '<div class="record-item"><div class="meta">' + dateTimeStr + (last.supervisor ? ' ' + last.supervisor : '') + '</div>';
              html += '<div class="feedback">' + (last.summary || last.fullFeedback || '').substring(0, 120) + ((last.summary || last.fullFeedback || '').length > 120 ? '…' : '') + '</div></div>';
            }
            html += '</div></div>';
          });
          el.innerHTML = html;
          
          // 為每個有資料的卡片添加點擊事件
          document.querySelectorAll('#areasBoard .area-card').forEach(function(card) {
            var area = card.getAttribute('data-area');
            if (areaRecords[area]) {
              card.addEventListener('click', function() {
                showRecordModal(areaRecords[area]);
              });
            }
          });
        }).catch(function() { el.innerHTML = '<div class="empty">無法載入，請確認 GAS_APP_URL</div>'; });
      }

      function loadList() {
        var el = document.getElementById('listRecords');
        el.innerHTML = '<div class="empty">載入中…</div>';
        if (!GAS_APP_URL || GAS_APP_URL.indexOf('XXXXXXXX') >= 0) { el.innerHTML = '<div class="empty">請先設定 GAS_APP_URL</div>'; return; }
        callGetRecords(null, 100).then(function(rows) {
          if (!rows || !rows.length) { el.innerHTML = '<div class="empty">尚無紀錄</div>'; return; }
          el.innerHTML = rows.map(function(r) {
            var s = '<div class="record-item">';
            s += '<div class="meta">' + (r.dateStr || '') + ' ' + (r.timeStr || '') + '｜' + (r.supervisor || '') + '｜廠區 ' + (r.area || '') + '</div>';
            s += '<span class="score-badge safety">安全 ' + (r.safetyScore != null ? r.safetyScore : '–') + '</span>';
            s += '<span class="score-badge clean">清潔 ' + (r.cleanlinessScore != null ? r.cleanlinessScore : '–') + '</span>';
            s += '<div class="feedback">' + (r.summary || r.fullFeedback || '').replace(/\n/g, '<br>') + '</div></div>';
            return s;
          }).join('');
        }).catch(function() { el.innerHTML = '<div class="empty">無法載入，請確認 GAS_APP_URL</div>'; });
      }

      var calY = new Date().getFullYear(), calM = new Date().getMonth();
      var selectedDate = null;
      var datesWithData = [];

      function renderCal() {
        document.getElementById('calTitle').textContent = calY + '-' + String(calM + 1).padStart(2, '0');
        if (!GAS_APP_URL || GAS_APP_URL.indexOf('XXXXXXXX') >= 0) {
          document.getElementById('calGrid').innerHTML = '<div class="empty" style="grid-column:1/-1">請先設定 GAS_APP_URL</div>';
          return;
        }
        callGetDates(String(calY), String(calM + 1)).then(function(dates) {
          datesWithData = dates || [];
          var first = new Date(calY, calM, 1);
          var last = new Date(calY, calM + 1, 0);
          var start = first.getDay();
          var days = last.getDate();
          var prev = new Date(calY, calM, 0).getDate();
          var html = [];
          ['日', '一', '二', '三', '四', '五', '六'].forEach(function(d) { html.push('<div style="padding:4px;color:var(--muted)">' + d + '</div>'); });
          var i, d, cls;
          for (i = 0; i < start; i++) {
            d = prev - start + i + 1;
            html.push('<div class="cal-cell other">' + d + '</div>');
          }
          for (i = 1; i <= days; i++) {
            cls = 'cal-cell';
            var dt = calY + '-' + String(calM + 1).padStart(2, '0') + '-' + String(i).padStart(2, '0');
            if (datesWithData.indexOf(dt) >= 0) cls += ' has-data';
            var today = new Date();
            if (calY === today.getFullYear() && calM === today.getMonth() && i === today.getDate()) cls += ' today';
            if (selectedDate === dt) cls += ' selected';
            html.push('<div class="' + cls + '" data-date="' + dt + '">' + i + '</div>');
          }
          var rest = 42 - (html.length - 7);
          for (i = 1; i <= rest; i++) html.push('<div class="cal-cell other">' + i + '</div>');
          document.getElementById('calGrid').innerHTML = html.slice(0, 7 + 42).join('');

          document.querySelectorAll('#calGrid .cal-cell[data-date]').forEach(function(c) {
            c.addEventListener('click', function() {
              selectedDate = this.getAttribute('data-date');
              document.getElementById('calDateTitle').textContent = selectedDate + ' 巡視紀錄';
              renderCal();
              loadDayRecords(selectedDate);
            });
          });
        });
      }

      document.getElementById('calPrev').addEventListener('click', function() {
        calM--; if (calM < 0) { calM = 11; calY--; } renderCal();
      });
      document.getElementById('calNext').addEventListener('click', function() {
        calM++; if (calM > 11) { calM = 0; calY++; } renderCal();
      });

      function loadDayRecords(dateStr) {
        var el = document.getElementById('calDayRecords');
        el.innerHTML = '<div class="empty">載入中…</div>';
        callGetRecords(dateStr, 50).then(function(rows) {
          if (!rows || !rows.length) { el.innerHTML = '<div class="empty">當日尚無巡視紀錄</div>'; return; }
          el.innerHTML = rows.map(function(r, idx) {
            var s = '<div class="record-item" data-record-index="' + idx + '">';
            s += '<div class="meta">' + (r.timeStr || '') + '｜' + (r.supervisor || '') + '｜廠區 ' + (r.area || '') + '</div>';
            s += '<span class="score-badge safety">安全 ' + (r.safetyScore != null ? r.safetyScore : '–') + '</span>';
            s += '<span class="score-badge clean">清潔 ' + (r.cleanlinessScore != null ? r.cleanlinessScore : '–') + '</span>';
            s += '<div class="feedback">' + (r.summary || r.fullFeedback || '').substring(0, 120) + ((r.summary || r.fullFeedback || '').length > 120 ? '…' : '') + '</div></div>';
            return s;
          }).join('');
          
          // 為每個紀錄項目添加點擊事件
          document.querySelectorAll('#calDayRecords .record-item').forEach(function(item, idx) {
            item.addEventListener('click', function() {
              showRecordModal(rows[idx]);
            });
          });
        }).catch(function() { el.innerHTML = '<div class="empty">無法載入</div>'; });
      }

      // 智能文字格式化函數（增強版：自動識別結構並格式化）
      function markdownToHtml(text) {
        if (!text) return '';
        var html = String(text);
        
        // 首先處理標準 Markdown 語法
        // 代碼塊 (```code```)
        html = html.replace(/```([\s\S]*?)```/g, function(match, code) {
          return '<pre><code>' + escapeHtml(code.trim()) + '</code></pre>';
        });
        
        // 行內代碼 (`code`)
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
        
        // 標準 Markdown 粗體 (**text** 或 __text__)
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
        
        // 標準 Markdown 標題
        html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
        
        // 智能段落分段：根據句號、問號、驚嘆號分段（保留原本的換行邏輯）
        // 先處理有明顯段落分隔的情況（雙換行）
        var hasDoubleNewline = /\n\n/.test(html);
        
        if (!hasDoubleNewline) {
          // 如果沒有雙換行，則根據標點符號智能分段
          // 將句號、問號、驚嘆號後的空白替換為特殊標記
          html = html.replace(/([。！？\?\!])\s*/g, '$1\n\n');
        }
        
        // 自動識別並加粗關鍵詞
        var keywords = [
          '建議', '需要', '必須', '應', '應', '注意', '警告', '危險', 
          '建議', '應確保', '應清理', '應檢查', '應整理',
          '可能', '構成', '影響', '風險', '安全', '清潔',
          '消防', '逃生', '通道', '設備', '電線', '整理'
        ];
        keywords.forEach(function(keyword) {
          var regex = new RegExp('(' + keyword + ')', 'g');
          html = html.replace(regex, '<strong style="color: #60a5fa; font-weight: 700;">$1</strong>');
        });
        
        // 自動識別數字編號（如「1) 項目」或「一、項目」）
        html = html.replace(/(\d+)[\.\)、]\s+([^\n<]+)/g, '<strong style="color: #60a5fa;">$1)</strong> $2');
        
        // 自動識別中文編號（如「一、」「二、」）
        html = html.replace(/([一二三四五六七八九十]+)[、．]\s*([^\n<]+)/g, '<strong style="color: #60a5fa;">$1、</strong> $2');
        
        // 段落處理：將連續的換行轉換為段落
        var paragraphs = html.split(/\n\n+/);
        var processedParagraphs = [];
        
        for (var p = 0; p < paragraphs.length; p++) {
          var para = paragraphs[p].trim();
          if (!para) continue;
          
          // 如果已經是 HTML 標籤（標題、列表、代碼等），直接使用
          if (para.match(/^<(h[1-6]|ul|ol|pre|blockquote|hr|li)/)) {
            processedParagraphs.push(para);
          } else {
            // 否則包裝成段落
            // 清理多餘的換行，但保留單個換行作為 <br>
            para = para.replace(/\n+/g, ' '); // 先合併多個換行
            processedParagraphs.push('<p>' + para + '</p>');
          }
        }
        
        html = processedParagraphs.join('\n\n');
        
        return html;
      }
      
      function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function showRecordModal(record) {
        var modal = document.getElementById('recordModal');
        var modalTitle = document.getElementById('modalTitle');
        var modalBody = document.getElementById('modalBody');
        
        // 設置標題
        var dateTimeStr = '';
        if (record.dateStr && record.timeStr) {
          var datePart = String(record.dateStr).substring(0, 10).replace(/-/g, '/');
          var timePart = String(record.timeStr).substring(0, 5);
          dateTimeStr = datePart + ' ' + timePart;
        }
        modalTitle.textContent = '廠區 ' + (record.area || '') + ' 巡視紀錄' + (dateTimeStr ? ' - ' + dateTimeStr : '');
        
        // 處理圖片 URL（與六區看板使用相同邏輯）
        function getImageUrl(url) {
          if (!url) return null;
          var fileId = null;
          // 嘗試多種 Google Drive URL 格式提取文件 ID
          var match1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
          if (match1 && match1[1]) {
            fileId = match1[1];
          } else {
            var match2 = url.match(/id=([a-zA-Z0-9_-]+)/);
            if (match2 && match2[1]) {
              fileId = match2[1];
            } else {
              // 嘗試提取長度 25-33 的字元串（Google Drive ID 的常見長度）
              var match3 = url.match(/[a-zA-Z0-9_-]{25,33}/);
              if (match3) {
                fileId = match3[0];
              }
            }
          }
          if (fileId) {
            // 使用 thumbnail API 獲取圖片（更可靠），w800 用於浮動視窗較大的顯示
            return 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w800';
          }
          return url;
        }
        
        // 生成內容 HTML
        var html = '';
        
        // 圖片區域
        html += '<div class="modal-images">';
        var img1Url = getImageUrl(record.photo1Url);
        var img2Url = getImageUrl(record.photo2Url);
        if (img1Url) {
          html += '<div class="modal-image"><img src="' + img1Url + '" alt="照片1" onerror="this.src=\'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJyZ2JhKDAsMCwwLDAuMikiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSIxNCIgZmlsbD0idmFyKC0tbXV0ZWQpIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+圖片載入失敗</text></svg>\';" /></div>';
        }
        if (img2Url) {
          html += '<div class="modal-image"><img src="' + img2Url + '" alt="照片2" onerror="this.src=\'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJyZ2JhKDAsMCwwLDAuMikiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSIxNCIgZmlsbD0idmFyKC0tbXV0ZWQpIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+圖片載入失敗</text></svg>\';" /></div>';
        }
        if (!img1Url && !img2Url) {
          html += '<div class="empty" style="grid-column: 1/-1;">無照片</div>';
        }
        html += '</div>';
        
        // 分數
        html += '<div class="modal-scores">';
        html += '<span class="score-badge safety">安全 ' + (record.safetyScore != null ? record.safetyScore : '–') + '</span>';
        html += '<span class="score-badge clean">清潔 ' + (record.cleanlinessScore != null ? record.cleanlinessScore : '–') + '</span>';
        html += '</div>';
        
        // 資訊
        html += '<div class="modal-info">';
        html += '日期：' + (dateTimeStr || record.dateStr || '–') + '<br>';
        html += '主管：' + (record.supervisor || '–') + '<br>';
        html += '廠區：' + (record.area || '–');
        html += '</div>';
        
        // 完整回饋（使用 Markdown 格式化）
        var feedback = record.fullFeedback || record.summary || '';
        html += '<div class="modal-feedback markdown-content">' + markdownToHtml(feedback) + '</div>';
        
        modalBody.innerHTML = html;
        modal.classList.add('active');
        
        // 點擊背景或關閉按鈕關閉視窗
        document.querySelector('#recordModal .modal-close').onclick = function() {
          modal.classList.remove('active');
        };
        modal.onclick = function(e) {
          if (e.target === modal) {
            modal.classList.remove('active');
          }
        };
      }

      function showToast(msg, type) {
        var t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast ' + (type === 'error' ? 'error' : 'success');
        t.style.display = 'block';
        clearTimeout(window._toastT);
        window._toastT = setTimeout(function() { t.style.display = 'none'; }, 3000);
      }
    })();
  </script>
</body>
</html>
